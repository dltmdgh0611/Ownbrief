# 데이터베이스 스키마 명세서

## 개요

OwnBrief는 PostgreSQL 데이터베이스를 사용하며, Prisma ORM을 통해 데이터를 관리합니다.

**데이터베이스**: PostgreSQL  
**ORM**: Prisma Client  
**스키마 파일**: `prisma/schema.prisma`

## ERD (Entity Relationship Diagram)

```
User (1) ──< (N) Account
User (1) ──< (N) Session
User (1) ──< (N) Podcast
User (1) ──── (1) UserSettings
```

---

## 테이블 목록

1. [User](#user) - 사용자 기본 정보
2. [Account](#account) - OAuth 계정 연동 정보
3. [Session](#session) - 세션 관리
4. [VerificationToken](#verificationtoken) - 이메일 인증 토큰
5. [Podcast](#podcast) - 팟캐스트 메타데이터
6. [UserSettings](#usersettings) - 사용자 설정 및 환경

---

## User

사용자 기본 정보를 저장하는 테이블입니다. NextAuth를 통한 Google OAuth 인증 시 자동으로 생성됩니다.

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | String | PRIMARY KEY, CUID | 사용자 고유 ID |
| `name` | String? | nullable | 사용자 이름 (Google 프로필) |
| `email` | String? | UNIQUE, nullable | 이메일 주소 |
| `emailVerified` | DateTime? | nullable | 이메일 인증 일시 |
| `image` | String? | nullable | 프로필 이미지 URL |
| `createdAt` | DateTime | default: now() | 계정 생성 일시 |
| `updatedAt` | DateTime | auto-update | 계정 수정 일시 |

### 관계 (Relations)

- `accounts` → Account[] (1:N)
- `sessions` → Session[] (1:N)
- `podcasts` → Podcast[] (1:N)
- `userSettings` → UserSettings? (1:1)

### 인덱스

- `email` - UNIQUE 인덱스

### 주요 특징

- NextAuth Adapter에서 자동 관리
- 계정 삭제 시 모든 관련 데이터 Cascade 삭제
- CUID를 사용하여 충돌 없는 고유 ID 생성

---

## Account

OAuth 계정 연동 정보를 저장합니다. Google OAuth를 통한 인증 시 액세스 토큰 등이 저장됩니다.

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | String | PRIMARY KEY, CUID | 계정 연동 고유 ID |
| `userId` | String | FOREIGN KEY → User.id | 사용자 ID |
| `type` | String | - | OAuth 타입 ("oauth") |
| `provider` | String | - | OAuth 프로바이더 ("google") |
| `providerAccountId` | String | - | 프로바이더의 사용자 ID |
| `refresh_token` | String? | TEXT, nullable | YouTube API 리프레시 토큰 |
| `access_token` | String? | TEXT, nullable | YouTube API 액세스 토큰 |
| `expires_at` | Int? | nullable | 토큰 만료 시간 (Unix timestamp) |
| `token_type` | String? | nullable | 토큰 타입 ("Bearer") |
| `scope` | String? | nullable | OAuth 스코프 |
| `id_token` | String? | TEXT, nullable | OpenID Connect ID 토큰 |
| `session_state` | String? | nullable | 세션 상태 |

### 관계 (Relations)

- `user` → User (N:1, onDelete: Cascade)

### 인덱스

- `(provider, providerAccountId)` - UNIQUE 복합 인덱스

### 주요 특징

- YouTube API 호출 시 `access_token` 사용
- 토큰 만료 시 `refresh_token`으로 재발급
- 사용자 삭제 시 함께 삭제 (Cascade)

---

## Session

사용자 세션 정보를 저장합니다. NextAuth의 Database Session Strategy를 사용할 경우 활용됩니다.

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | String | PRIMARY KEY, CUID | 세션 고유 ID |
| `sessionToken` | String | UNIQUE | 세션 토큰 |
| `userId` | String | FOREIGN KEY → User.id | 사용자 ID |
| `expires` | DateTime | - | 세션 만료 일시 |

### 관계 (Relations)

- `user` → User (N:1, onDelete: Cascade)

### 인덱스

- `sessionToken` - UNIQUE 인덱스

### 주요 특징

- NextAuth에서 자동 관리
- 사용자 삭제 시 함께 삭제 (Cascade)

---

## VerificationToken

이메일 인증 토큰을 저장합니다. (현재 프로젝트에서는 미사용)

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `identifier` | String | - | 식별자 (이메일 등) |
| `token` | String | UNIQUE | 인증 토큰 |
| `expires` | DateTime | - | 토큰 만료 일시 |

### 인덱스

- `token` - UNIQUE 인덱스
- `(identifier, token)` - UNIQUE 복합 인덱스

---

## Podcast

팟캐스트 메타데이터 및 생성 상태를 저장합니다.

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | String | PRIMARY KEY, CUID | 팟캐스트 고유 ID |
| `title` | String | - | 팟캐스트 제목 |
| `description` | String? | nullable | 팟캐스트 설명 |
| `audioUrl` | String? | nullable | 오디오 파일 URL 또는 API 경로 |
| `duration` | Int? | nullable | 재생 시간 (초) |
| `status` | String | default: "pending" | 생성 상태 |
| `script` | String | - | 팟캐스트 스크립트 (Gemini AI 생성) |
| `userId` | String | FOREIGN KEY → User.id | 소유자 ID |
| `publishedAt` | DateTime? | nullable | 공개 예정 시간 |
| `isAutoGenerated` | Boolean | default: false | 자동 생성 여부 (Cron) |
| `createdAt` | DateTime | default: now() | 생성 일시 |
| `updatedAt` | DateTime | auto-update | 수정 일시 |

### 관계 (Relations)

- `user` → User (N:1, onDelete: Cascade)

### Status 값

| Status | 설명 |
|--------|------|
| `pending` | 생성 대기 중 |
| `processing` | 스크립트/음성 생성 중 |
| `completed` | 생성 완료 |
| `failed` | 생성 실패 |

### 주요 특징

- 사용자 삭제 시 함께 삭제 (Cascade)
- `audioUrl`은 실제 파일 경로가 아닌 API 경로(`/api/podcast/{id}/audio`)로 저장 가능
- `duration`은 WAV 헤더에서 자동 계산
- `publishedAt`이 설정된 경우 해당 시간 이후에만 접근 가능

---

## UserSettings

사용자별 설정 및 환경을 저장합니다. 온보딩, 플레이리스트, 크레딧, 추천인 코드 등을 관리합니다.

### 컬럼

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | String | PRIMARY KEY, CUID | 설정 고유 ID |
| `userId` | String | UNIQUE, FOREIGN KEY → User.id | 사용자 ID |
| `selectedPlaylists` | String[] | default: [] | 선택한 YouTube 플레이리스트 ID 배열 |
| `interests` | String[] | default: [] | 관심 키워드 배열 |
| `onboardingCompleted` | Boolean | default: false | 온보딩 완료 여부 |
| `deliveryTimeHour` | Int | default: 8 | 팟캐스트 배달 시간 (0-23) |
| `deliveryTimeMinute` | Int | default: 0 | 팟캐스트 배달 분 (0-59) |
| `lastDeliveryTimeUpdate` | DateTime? | nullable | 마지막 배달 시간 변경 일시 |
| `credits` | Int | default: 15 | 남은 크레딧 수 |
| `isAdmin` | Boolean | default: false | 관리자 권한 여부 |
| `referralCode` | String? | UNIQUE, nullable | 사용자 고유 추천인 코드 (8자 영숫자) |
| `referredBy` | String? | nullable | 사용자를 초대한 추천인 코드 |
| `referralCount` | Int | default: 0 | 이 사용자가 초대한 사람 수 |
| `createdAt` | DateTime | default: now() | 설정 생성 일시 |
| `updatedAt` | DateTime | auto-update | 설정 수정 일시 |

### 관계 (Relations)

- `user` → User (1:1, onDelete: Cascade)

### 인덱스

- `userId` - UNIQUE 인덱스
- `referralCode` - UNIQUE 인덱스

### 주요 특징

- **크레딧 시스템**:
  - 기본 15 크레딧으로 시작
  - 추천인 코드 사용 시 25 크레딧 (15+10)
  - 팟캐스트 생성 시 1 크레딧 차감
  - 관리자는 사용자 크레딧 조정 가능

- **추천인 시스템**:
  - 신규 가입 시 자동으로 8자 추천인 코드 생성
  - 추천인 코드 입력 시 양측 모두 10 크레딧 획득
  - `referralCount`로 추천 실적 추적

- **온보딩**:
  - `onboardingCompleted`가 false면 온보딩 페이지로 리다이렉트
  - 최소 1개 이상의 관심사와 플레이리스트 필요

- **자동 생성 스케줄**:
  - `deliveryTimeHour`와 `deliveryTimeMinute`로 매일 팟캐스트 생성 시간 지정
  - Vercel Cron이 매시간 실행되어 해당 시간에 도달한 사용자 대상 생성

---

## 마이그레이션 이력

### 20250923091922_aicast1
- 초기 스키마 생성 (User, Account, Session, VerificationToken, Podcast)

### 20250923104458_add_user_settings
- UserSettings 테이블 추가

### 20250923133859_add_script_field
- Podcast 테이블에 script 필드 추가

### 20250923134621_add_script_field_back
- script 필드 재추가

### 20251008084719_add_interests_and_onboarding
- UserSettings에 interests, onboardingCompleted 필드 추가

### 20251008093044_add_cascade_delete_to_user_settings
- UserSettings에 Cascade Delete 추가

### 20251010133209_add_delivery_time_and_credits
- deliveryTimeHour, deliveryTimeMinute, credits, referralCode 등 추가

---

## 데이터베이스 연결

### 환경 변수

```env
DATABASE_URL="postgresql://user:password@host:port/dbname"
```

### Prisma 명령어

```bash
# 마이그레이션 실행
npm run db:migrate

# Prisma Client 생성
npm run db:generate

# Prisma Studio (GUI)
npm run db:studio

# 데이터베이스 리셋 (주의!)
npm run db:reset
```

---

## 보안 및 최적화

### RLS (Row Level Security)
- 현재 Prisma를 사용하므로 애플리케이션 레벨에서 권한 관리
- 모든 쿼리는 세션을 통해 userId 기반으로 필터링

### 인덱싱 전략
- 자주 조회되는 컬럼에 인덱스 설정 (email, sessionToken, userId 등)
- UNIQUE 제약조건으로 데이터 무결성 보장

### 데이터 정합성
- Foreign Key + Cascade Delete로 고아 레코드 방지
- 사용자 삭제 시 모든 관련 데이터 자동 삭제

---

## 참고 사항

1. **CUID vs UUID**: CUID는 충돌 가능성이 낮고 시간 순서 정렬이 가능하여 Prisma 기본값으로 사용
2. **TEXT vs String**: PostgreSQL에서 String은 VARCHAR(191), 긴 텍스트는 @db.Text 사용
3. **배열 타입**: PostgreSQL의 Array 타입 사용 (selectedPlaylists, interests)
4. **Timestamp**: DateTime 타입은 PostgreSQL의 TIMESTAMP WITH TIME ZONE으로 변환







