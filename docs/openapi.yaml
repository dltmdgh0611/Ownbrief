openapi: 3.0.3
info:
  title: OwnBrief API
  description: |
    OwnBrief는 YouTube 플레이리스트를 기반으로 AI가 생성한 팟캐스트를 제공하는 서비스입니다.
    
    이 API는 사용자 인증, 팟캐스트 생성 및 관리, YouTube 플레이리스트 통합, 
    온보딩 프로세스 등의 기능을 제공합니다.
    
    ## 인증
    대부분의 엔드포인트는 NextAuth를 통한 세션 인증이 필요합니다.
    
    ## 기술 스택
    - Next.js 14 (App Router)
    - Prisma ORM
    - PostgreSQL
    - Google Gemini AI
    - Google OAuth & YouTube API
    - Supabase Storage
  version: 1.0.0
  contact:
    name: OwnBrief Team
servers:
  - url: http://localhost:3000
    description: 로컬 개발 서버
  - url: https://your-production-url.vercel.app
    description: 프로덕션 서버

tags:
  - name: Auth
    description: 인증 관련 엔드포인트
  - name: Podcast
    description: 팟캐스트 생성 및 관리
  - name: User
    description: 사용자 정보 및 설정
  - name: Onboarding
    description: 사용자 온보딩 프로세스
  - name: YouTube
    description: YouTube 플레이리스트 통합
  - name: Admin
    description: 관리자 전용 기능
  - name: Cron
    description: 예약된 작업
  - name: Dev
    description: 개발 및 테스트용 엔드포인트
  - name: Health
    description: 헬스 체크

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
      description: NextAuth 세션 쿠키

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          description: 사용자 고유 ID (CUID)
        name:
          type: string
          nullable: true
        email:
          type: string
          format: email
        image:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Podcast:
      type: object
      properties:
        id:
          type: string
          description: 팟캐스트 고유 ID (CUID)
        title:
          type: string
        description:
          type: string
          nullable: true
        audioUrl:
          type: string
          nullable: true
        duration:
          type: integer
          description: 재생 시간 (초)
          nullable: true
        status:
          type: string
          enum: [pending, processing, completed, failed]
          default: pending
        script:
          type: string
          description: 팟캐스트 스크립트
        userId:
          type: string
        publishedAt:
          type: string
          format: date-time
          nullable: true
          description: 공개 예정 시간
        isAutoGenerated:
          type: boolean
          default: false
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserSettings:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        selectedPlaylists:
          type: array
          items:
            type: string
          description: 선택한 YouTube 플레이리스트 ID 배열
        interests:
          type: array
          items:
            type: string
          description: 관심 키워드 배열
        onboardingCompleted:
          type: boolean
          default: false
        deliveryTimeHour:
          type: integer
          minimum: 0
          maximum: 23
          default: 8
        deliveryTimeMinute:
          type: integer
          minimum: 0
          maximum: 59
          default: 0
        credits:
          type: integer
          default: 15
        isAdmin:
          type: boolean
          default: false
        referralCode:
          type: string
          nullable: true
          description: 사용자 고유 추천인 코드 (8자)
        referredBy:
          type: string
          nullable: true
        referralCount:
          type: integer
          default: 0
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    YouTubePlaylist:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        itemCount:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
          description: 에러 메시지
        errorCode:
          type: string
          description: 에러 코드 (선택적)

paths:
  # ==================== Auth ====================
  /api/auth/[...nextauth]:
    get:
      tags:
        - Auth
      summary: NextAuth 인증 핸들러
      description: NextAuth를 통한 Google OAuth 인증 처리
      responses:
        '302':
          description: 인증 페이지로 리다이렉트
    post:
      tags:
        - Auth
      summary: NextAuth 콜백 처리
      responses:
        '200':
          description: 인증 성공

  /api/auth/reauthorize:
    post:
      tags:
        - Auth
      summary: YouTube API 권한 재승인
      description: YouTube API 권한이 만료된 경우 재승인 URL 제공
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 재승인 URL 반환
          content:
            application/json:
              schema:
                type: object
                properties:
                  reauthorizeUrl:
                    type: string
        '401':
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== Podcast ====================
  /api/podcast:
    get:
      tags:
        - Podcast
      summary: 팟캐스트 목록 조회
      description: 현재 로그인한 사용자의 팟캐스트 목록 조회
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 팟캐스트 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Podcast'
        '401':
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/podcast/generate:
    post:
      tags:
        - Podcast
      summary: 팟캐스트 생성
      description: |
        선택한 YouTube 플레이리스트의 영상들을 기반으로 팟캐스트 생성
        - 최근 5개 영상의 자막 추출
        - Gemini AI를 사용한 스크립트 생성
        - 멀티 스피커 TTS로 음성 생성
        - 최대 실행 시간: 300초
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 팟캐스트 생성 시작
          content:
            application/json:
              schema:
                type: object
                properties:
                  podcastId:
                    type: string
                  script:
                    type: string
                  videos:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                        thumbnail:
                          type: string
                  status:
                    type: string
                  message:
                    type: string
        '400':
          description: 잘못된 요청 (플레이리스트 미선택 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 사용자 또는 영상을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/podcast/generate-voice:
    post:
      tags:
        - Podcast
      summary: 음성 생성 (독립 실행)
      description: 기존 스크립트로부터 음성만 생성
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                script:
                  type: string
                podcastId:
                  type: string
      responses:
        '200':
          description: 음성 생성 성공
        '401':
          description: 인증 필요

  /api/podcast/script:
    post:
      tags:
        - Podcast
      summary: 스크립트 생성
      description: 자막 텍스트로부터 팟캐스트 스크립트 생성
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transcript:
                  type: string
      responses:
        '200':
          description: 스크립트 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  script:
                    type: string

  /api/podcast/script-stream:
    post:
      tags:
        - Podcast
      summary: 스크립트 스트리밍 생성
      description: 스크립트를 실시간 스트리밍으로 생성
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 스트리밍 응답 (text/event-stream)

  /api/podcast/{id}/audio:
    get:
      tags:
        - Podcast
      summary: 팟캐스트 오디오 스트리밍
      description: 팟캐스트 오디오 파일 스트리밍 (WAV 형식)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 팟캐스트 ID
      responses:
        '200':
          description: 오디오 파일 스트림
          content:
            audio/wav:
              schema:
                type: string
                format: binary
        '404':
          description: 오디오 파일을 찾을 수 없음

  /api/podcast/videos:
    post:
      tags:
        - Podcast
      summary: YouTube 영상 목록 조회
      description: 선택한 플레이리스트의 영상 목록 조회
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                playlistIds:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: 영상 목록

  # ==================== User ====================
  /api/user/credits:
    get:
      tags:
        - User
      summary: 사용자 크레딧 조회
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 크레딧 정보
          content:
            application/json:
              schema:
                type: object
                properties:
                  credits:
                    type: integer
        '401':
          description: 인증 필요

  /api/user/settings:
    get:
      tags:
        - User
      summary: 사용자 설정 조회
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 사용자 설정
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '401':
          description: 인증 필요

    post:
      tags:
        - User
      summary: 사용자 설정 저장
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                selectedPlaylists:
                  type: array
                  items:
                    type: string
                interests:
                  type: array
                  items:
                    type: string
                deliveryTimeHour:
                  type: integer
                deliveryTimeMinute:
                  type: integer
      responses:
        '200':
          description: 설정 저장 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '401':
          description: 인증 필요

  /api/user/check-token:
    get:
      tags:
        - User
      summary: YouTube API 토큰 상태 확인
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 토큰 상태
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasToken:
                    type: boolean
                  isExpired:
                    type: boolean
        '401':
          description: 인증 필요

  /api/user/delete:
    delete:
      tags:
        - User
      summary: 사용자 계정 삭제
      description: 사용자 계정 및 관련 모든 데이터 삭제
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 계정 삭제 성공
        '401':
          description: 인증 필요

  # ==================== Onboarding ====================
  /api/onboarding/status:
    get:
      tags:
        - Onboarding
      summary: 온보딩 상태 확인
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 온보딩 상태
          content:
            application/json:
              schema:
                type: object
                properties:
                  isNewUser:
                    type: boolean
                  needsOnboarding:
                    type: boolean
                  settings:
                    $ref: '#/components/schemas/UserSettings'
                    nullable: true
        '401':
          description: 인증 필요

  /api/onboarding/complete:
    post:
      tags:
        - Onboarding
      summary: 온보딩 완료 처리
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - interests
                - selectedPlaylists
              properties:
                interests:
                  type: array
                  items:
                    type: string
                  minItems: 1
                selectedPlaylists:
                  type: array
                  items:
                    type: string
                  minItems: 1
                deliveryTimeHour:
                  type: integer
                  minimum: 0
                  maximum: 23
                  default: 8
                deliveryTimeMinute:
                  type: integer
                  minimum: 0
                  maximum: 59
                  default: 0
                referralCode:
                  type: string
                  description: 추천인 코드 (선택적)
      responses:
        '200':
          description: 온보딩 완료 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  settings:
                    $ref: '#/components/schemas/UserSettings'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증 필요

  /api/onboarding/interests:
    put:
      tags:
        - Onboarding
      summary: 관심사 업데이트
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                interests:
                  type: array
                  items:
                    type: string
                  minItems: 1
      responses:
        '200':
          description: 관심사 업데이트 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  settings:
                    $ref: '#/components/schemas/UserSettings'
        '400':
          description: 잘못된 요청
        '401':
          description: 인증 필요

  # ==================== YouTube ====================
  /api/youtube/playlists:
    get:
      tags:
        - YouTube
      summary: YouTube 플레이리스트 목록 조회
      description: 사용자의 YouTube 플레이리스트 목록 조회 (최대 50개)
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 플레이리스트 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  playlists:
                    type: array
                    items:
                      $ref: '#/components/schemas/YouTubePlaylist'
        '401':
          description: 인증 필요

    post:
      tags:
        - YouTube
      summary: YouTube 플레이리스트 생성
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
      responses:
        '200':
          description: 플레이리스트 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  playlist:
                    $ref: '#/components/schemas/YouTubePlaylist'
        '400':
          description: 잘못된 요청
        '401':
          description: 인증 필요
        '404':
          description: YouTube 채널을 찾을 수 없음

  # ==================== Admin ====================
  /api/admin/check-permission:
    get:
      tags:
        - Admin
      summary: 관리자 권한 확인
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 권한 정보
          content:
            application/json:
              schema:
                type: object
                properties:
                  isAdmin:
                    type: boolean
        '401':
          description: 인증 필요

  /api/admin/adjust-credits:
    post:
      tags:
        - Admin
      summary: 사용자 크레딧 조정 (관리자 전용)
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - targetEmail
                - credits
              properties:
                targetEmail:
                  type: string
                  format: email
                credits:
                  type: integer
                  description: 설정할 크레딧 양
      responses:
        '200':
          description: 크레딧 조정 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  targetEmail:
                    type: string
                  credits:
                    type: integer
                  message:
                    type: string
        '400':
          description: 잘못된 요청
        '401':
          description: 인증 필요
        '403':
          description: 관리자 권한 필요

  # ==================== Cron ====================
  /api/cron/auto-generate-podcasts:
    post:
      tags:
        - Cron
      summary: 자동 팟캐스트 생성 (예약 작업)
      description: |
        모든 사용자를 대상으로 설정된 배달 시간에 자동으로 팟캐스트 생성
        - Vercel Cron으로 실행
        - 크레딧이 있는 사용자만 대상
      responses:
        '200':
          description: 자동 생성 작업 완료
        '500':
          description: 서버 오류

  # ==================== Dev ====================
  /api/dev/test-apify:
    post:
      tags:
        - Dev
      summary: Apify 자막 추출 테스트
      description: 개발 환경에서만 사용 가능
      responses:
        '200':
          description: 테스트 성공

  /api/dev/test-auto-generate:
    post:
      tags:
        - Dev
      summary: 자동 생성 프로세스 테스트
      responses:
        '200':
          description: 테스트 성공

  /api/dev/check-db-token:
    get:
      tags:
        - Dev
      summary: 데이터베이스 토큰 확인
      responses:
        '200':
          description: 토큰 정보

  /api/dev/check-supabase-policies:
    get:
      tags:
        - Dev
      summary: Supabase 정책 확인
      responses:
        '200':
          description: 정책 정보

  /api/dev/test-podcast-upload:
    post:
      tags:
        - Dev
      summary: 팟캐스트 업로드 테스트
      responses:
        '200':
          description: 테스트 성공

  /api/dev/test-script-generation:
    post:
      tags:
        - Dev
      summary: 스크립트 생성 테스트
      responses:
        '200':
          description: 테스트 성공

  /api/dev/test-supabase-upload:
    post:
      tags:
        - Dev
      summary: Supabase 업로드 테스트
      responses:
        '200':
          description: 테스트 성공

  /api/dev/test-tts:
    post:
      tags:
        - Dev
      summary: TTS 음성 생성 테스트
      responses:
        '200':
          description: 테스트 성공

  # ==================== Health ====================
  /api/health:
    get:
      tags:
        - Health
      summary: 헬스 체크
      description: API 서버 상태 확인
      responses:
        '200':
          description: 서버 정상
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time






