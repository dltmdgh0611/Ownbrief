# 스케줄 팟캐스트 생성 시스템 설정 가이드

## 개요

이 시스템은 사용자가 설정한 시간에 자동으로 팟캐스트를 생성하는 기능을 제공합니다.

## 주요 기능

1. **시간 설정**: 온보딩 및 설정 페이지에서 매일 팟캐스트를 받을 시간 설정
2. **자동 생성**: Vercel Cron Job이 매시간 실행되어 해당 시간의 사용자들을 위해 팟캐스트 자동 생성
3. **크레딧 시스템**: 초기 15개 크레딧으로 시작하며, 팟캐스트 생성 시 1개씩 차감
4. **공개 시간 관리**: 설정한 시간 1시간 전에 생성하여 설정한 시간에 공개

## 설정 방법

### 1. 환경 변수 설정

`.env` 파일에 다음 환경 변수를 추가하세요:

```bash
# Vercel Cron Job 보안을 위한 시크릿 키
CRON_SECRET=your-random-secret-key-here
```

**CRON_SECRET 생성 방법:**
```bash
# Node.js로 랜덤 시크릿 생성
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. 데이터베이스 마이그레이션

스키마가 업데이트되었으므로 마이그레이션을 실행하세요:

```bash
npx prisma migrate dev --name add_delivery_time_and_credits
```

또는 프로덕션에서:

```bash
npx prisma migrate deploy
```

### 3. Vercel 배포 설정

Vercel에서 환경 변수를 설정하세요:

1. Vercel Dashboard > 프로젝트 선택 > Settings > Environment Variables
2. `CRON_SECRET` 추가 (로컬과 동일한 값 사용)

### 4. Vercel Cron Job 인증 설정

`vercel.json`이 이미 생성되어 있으므로, Vercel 배포 시 자동으로 Cron Job이 설정됩니다.

**Cron Job 스케줄:**
- **주기**: 매시간 정각 (0 * * * *)
- **엔드포인트**: `/api/cron/auto-generate-podcasts`
- **로직**: 현재 시간 + 1시간에 설정된 사용자들의 팟캐스트 자동 생성

## 사용자 플로우

### 1. 온보딩

사용자는 온보딩 과정에서 다음을 설정합니다:
- 관심사 (최대 5개)
- 플레이리스트 선택
- **팟캐스트 받을 시간** (기본값: 오전 8시 0분)

### 2. 자동 생성

- 설정한 시간 1시간 전에 서버가 자동으로 팟캐스트 생성 시작
- 유튜브 플레이리스트에서 최신 5개 영상 가져오기
- 자막 추출 → 스크립트 생성 → 음성 생성
- 크레딧 1개 차감

### 3. 공개

- 팟캐스트는 생성 즉시 데이터베이스에 저장되지만 `publishedAt` 시간까지 비공개
- 프론트엔드에서 카운트다운 표시
- 설정한 시간이 되면 자동으로 플레이 가능

### 4. 크레딧 관리

- 초기 크레딧: 15개
- 팟캐스트 생성 시 1개 차감
- 크레딧이 0이면 생성 불가 (안내 메시지 표시)
- 수동 생성 시에도 크레딧 차감 (향후 구현 필요)

## API 엔드포인트

### Cron Job API

**GET** `/api/cron/auto-generate-podcasts`

- **인증**: Bearer Token (`CRON_SECRET`)
- **로직**:
  1. 현재 시간 + 1시간 계산
  2. 해당 시간에 팟캐스트 받기로 설정한 사용자 조회
  3. 각 사용자별로:
     - 크레딧 확인 (0개 이하면 스킵)
     - 팟캐스트 생성 프로세스 실행
     - 크레딧 차감

### 크레딧 API

**GET** `/api/user/credits`

- 현재 사용자의 크레딧 조회
- 응답: `{ credits: number }`

## 프론트엔드 변경사항

### 1. 온보딩 페이지 (`app/onboarding/page.tsx`)

- Step 5에 시간 선택 UI 추가
- 시간(0-23시), 분(0, 15, 30, 45분) 선택 드롭다운

### 2. 팟캐스트 생성 페이지 (`frontend/components/PodcastGenerator.tsx`)

- **크레딧 표시**: 상단에 크레딧 잔량 카드
- **공개 시간 카운트다운**: 아직 공개되지 않은 팟캐스트에 카운트다운 표시
- **자동생성 배지**: 자동 생성된 팟캐스트 표시
- **크레딧 부족 시**: 생성 버튼 비활성화 및 안내 메시지

### 3. 설정 페이지 (`app/settings/page.tsx`)

- **배달 시간 설정**: 시간 변경 가능
- 변경 시 저장 버튼으로 업데이트

## 데이터베이스 스키마 변경

### UserSettings 모델

```prisma
model UserSettings {
  // ... 기존 필드
  deliveryTimeHour     Int      @default(8)   // 팟캐스트 받을 시간 (0-23)
  deliveryTimeMinute   Int      @default(0)   // 팟캐스트 받을 분 (0-59)
  credits              Int      @default(15)  // 남은 크레딧 수
}
```

### Podcast 모델

```prisma
model Podcast {
  // ... 기존 필드
  publishedAt     DateTime? // 공개 예정 시간
  isAutoGenerated Boolean   @default(false) // 자동 생성 여부
}
```

## 테스트

### 로컬 테스트

1. `.env`에 `CRON_SECRET` 설정
2. 다음 명령어로 Cron Job API 직접 호출:

```bash
curl -X GET http://localhost:3000/api/cron/auto-generate-podcasts \
  -H "Authorization: Bearer your-cron-secret"
```

### Vercel 테스트

1. Vercel Dashboard > Deployments > 최신 배포 선택
2. Cron Jobs 탭에서 수동 실행 가능

## 주의사항

1. **타임존**: 모든 시간은 서버의 타임존(UTC)을 기준으로 처리됩니다. 필요시 사용자 타임존 고려 추가
2. **크레딧 충전**: 현재 크레딧 충전 기능은 없으므로 수동으로 데이터베이스에서 업데이트 필요
3. **에러 처리**: Cron Job 실행 중 에러 발생 시 로그 확인 필요
4. **성능**: 많은 사용자가 동일한 시간에 설정할 경우 성능 고려 필요

## 트러블슈팅

### Cron Job이 실행되지 않음

- Vercel Dashboard에서 Cron Jobs 탭 확인
- `CRON_SECRET` 환경 변수 확인
- `vercel.json` 파일이 올바르게 배포되었는지 확인

### 팟캐스트가 생성되지 않음

- Vercel Function Logs 확인
- 사용자의 크레딧 확인
- YouTube API 토큰 유효성 확인

### 크레딧이 차감되지 않음

- 데이터베이스 마이그레이션 확인
- Prisma Client 재생성 확인: `npx prisma generate`

## 향후 개선 사항

1. 크레딧 구매/충전 기능
2. 타임존 설정 기능
3. 생성 실패 시 재시도 메커니즘
4. 이메일/푸시 알림 (팟캐스트 준비 완료 시)
5. 통계 및 분석 대시보드

